name: Debug ZMK overlays

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  dump-overlays:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run overlay/dts search and collect outputs
        shell: bash
        run: |
          set -euo pipefail
          out=diagnostic.txt
          echo "=== date ===" >"$out"
          date >>"$out" 2>&1
          echo "" >>"$out"

          echo "=== find zmk/app overlays/dts ===" >>"$out"
          find zmk/app -type f \( -name '*.overlay' -o -name '*.dts' \) -print >>"$out" 2>&1 || true
          echo "" >>"$out"

          echo "=== find /tmp/zmk-config (maxdepth 3) ===" >>"$out"
          find /tmp/zmk-config -maxdepth 3 -type f \( -name '*.overlay' -o -name '*.dts' -o -name '*.keymap' -o -name '*.conf' \) -print >>"$out" 2>&1 || echo "/tmp/zmk-config not present" >>"$out"
          echo "" >>"$out"

          echo "=== ls -la /tmp/zmk-config/config ===" >>"$out"
          ls -la /tmp/zmk-config/config >>"$out" 2>&1 || echo "/tmp/zmk-config/config not present" >>"$out"
          echo "" >>"$out"

          echo "=== sed first 240 lines of known overlays if present ===" >>"$out"
          sed -n '1,240p' zmk/app/boards/shields/corne/corne_right.overlay >>"$out" 2>/dev/null || true
          sed -n '1,240p' zmk/app/boards/shields/corne/corne_left.overlay >>"$out" 2>/dev/null || true
          sed -n '1,240p' zmk/app/boards/shields/corne/boards/nice_nano.overlay >>"$out" 2>/dev/null || true
          sed -n '1,240p' zmk/app/boards/arm/nice_nano/nice_nano.dts >>"$out" 2>/dev/null || true
          echo "" >>"$out"

          echo "=== grep spi3/spi3_default in repo and /tmp/zmk-config ===" >>"$out"
          grep -RIn --exclude-dir=.git 'spi3_default' . /tmp/zmk-config 2>/dev/null || true
          grep -RIn --exclude-dir=.git '&spi3_default' . /tmp/zmk-config 2>/dev/null || true
          grep -RIn --exclude-dir=.git 'spi3' . /tmp/zmk-config 2>/dev/null || true

          # Если в логах был путь типа /tmp/tmp.S0uDWdlLMi, можно захватить zephyr.dts.pre
          echo "" >>"$out"
          echo "=== searching for zephyr.dts.pre in /tmp ===" >>"$out"
          find /tmp -maxdepth 3 -type f -name 'zephyr.dts.pre' -print >>"$out" 2>&1 || true
          for f in $(find /tmp -maxdepth 3 -type f -name 'zephyr.dts.pre' 2>/dev/null || true); do
            echo "" >>"$out"
            echo "=== content of $f (first 200 lines) ===" >>"$out"
            sed -n '1,200p' "$f" >>"$out" 2>&1 || true
            echo "" >>"$out"
            grep -nE 'spi3_default|pin-controller|&spi3|pinctrl-0|#binding-cells' "$f" >>"$out" 2>&1 || true
          done

          echo "Diagnostics saved to $out"
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: zmk-overlay-diagnostics
          path: diagnostic.txt
